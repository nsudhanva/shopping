rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function isString(val, minLen, maxLen) {
      return val is string && val.size() >= minLen && val.size() <= maxLen;
    }

    function isTimestamp(val) {
      return val is timestamp;
    }

    function isNumber(val) {
      return val is number;
    }

    function hasKey(data, key) {
      return data.keys().hasAny([key]);
    }

    function optionalString(data, key, minLen, maxLen) {
      return !hasKey(data, key) || isString(data[key], minLen, maxLen);
    }

    function optionalNumber(data, key) {
      return !hasKey(data, key) || isNumber(data[key]);
    }

    function isValidListCreate(data) {
      return data.keys().hasOnly([
          "name",
          "createdAt",
          "updatedAt",
          "createdBy",
          "createdByName",
          "updatedByName",
          "isDefault",
          "order"
        ]) &&
        isString(data.name, 1, 60) &&
        data.isDefault is bool &&
        isTimestamp(data.createdAt) &&
        isTimestamp(data.updatedAt) &&
        isString(data.createdBy, 1, 128) &&
        data.createdBy == request.auth.uid &&
        optionalString(data, "createdByName", 1, 128) &&
        optionalString(data, "updatedByName", 1, 128) &&
        isNumber(data.order);
    }

    function isValidListUpdate(resourceData, newData) {
      return newData.keys().hasOnly([
          "name",
          "createdAt",
          "updatedAt",
          "createdBy",
          "createdByName",
          "updatedByName",
          "isDefault",
          "order"
        ]) &&
        isString(newData.name, 1, 60) &&
        newData.isDefault is bool &&
        isTimestamp(newData.createdAt) &&
        isTimestamp(newData.updatedAt) &&
        isString(newData.createdBy, 1, 128) &&
        newData.createdBy == resourceData.createdBy &&
        newData.createdAt == resourceData.createdAt &&
        optionalString(newData, "createdByName", 1, 128) &&
        optionalString(newData, "updatedByName", 1, 128) &&
        optionalNumber(newData, "order");
    }

    function isValidItemCreate(data) {
      return data.keys().hasOnly([
          "text",
          "checked",
          "quantity",
          "unit",
          "createdAt",
          "updatedAt",
          "createdBy",
          "createdByName",
          "updatedByName",
          "order"
        ]) &&
        isString(data.text, 1, 120) &&
        data.checked is bool &&
        isNumber(data.quantity) &&
        optionalString(data, "unit", 0, 16) &&
        isTimestamp(data.createdAt) &&
        isTimestamp(data.updatedAt) &&
        isString(data.createdBy, 1, 128) &&
        data.createdBy == request.auth.uid &&
        optionalString(data, "createdByName", 1, 128) &&
        optionalString(data, "updatedByName", 1, 128) &&
        isNumber(data.order);
    }

    function isValidItemUpdate(resourceData, newData) {
      return newData.keys().hasOnly([
          "text",
          "checked",
          "quantity",
          "unit",
          "createdAt",
          "updatedAt",
          "createdBy",
          "createdByName",
          "updatedByName",
          "order"
        ]) &&
        isString(newData.text, 1, 120) &&
        newData.checked is bool &&
        optionalNumber(newData, "quantity") &&
        optionalString(newData, "unit", 0, 16) &&
        isTimestamp(newData.createdAt) &&
        isTimestamp(newData.updatedAt) &&
        isString(newData.createdBy, 1, 128) &&
        newData.createdBy == resourceData.createdBy &&
        newData.createdAt == resourceData.createdAt &&
        optionalString(newData, "createdByName", 1, 128) &&
        optionalString(newData, "updatedByName", 1, 128) &&
        optionalNumber(newData, "order");
    }

    match /lists/{listId} {
      allow read: if true;
      allow create: if isSignedIn() && isValidListCreate(request.resource.data);
      allow update: if isSignedIn() && isValidListUpdate(resource.data, request.resource.data);
      allow delete: if isSignedIn();

      match /items/{itemId} {
        allow read: if true;
        allow create: if isSignedIn() && isValidItemCreate(request.resource.data);
        allow update: if isSignedIn() && isValidItemUpdate(resource.data, request.resource.data);
        allow delete: if isSignedIn();
      }
    }
  }
}
